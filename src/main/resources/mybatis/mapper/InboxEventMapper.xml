<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="aladin.webhook.infra.mybatis.mapper.InboxEventMapper">

    <insert id="insertReceived">
        INSERT INTO inbox_events(
            event_id, source_system, event_type, account_key,
            signature, request_timestamp, payload_json,
            status, received_at
        ) VALUES (
                     #{eventId}, #{sourceSystem}, #{eventType}, #{accountKey},
                     #{signature}, #{requestTimestamp}, #{payloadJson},
                     'RECEIVED', CURRENT_TIMESTAMP
                 )
    </insert>

    <select id="selectByEventId"
            resultType="aladin.webhook.infra.mybatis.model.InboxEventRow">
        SELECT
            inbox_event_id,
            event_id,
            source_system,
            event_type,
            account_key,
            signature,
            request_timestamp,
            payload_json,
            status,
            error_message,
            received_at,
            processed_at
        FROM inbox_events
        WHERE event_id = #{eventId}
    </select>

    <!-- RECEIVED 상태일 때만 PROCESSING으로 선점 -->
    <update id="updateToProcessingIfReceived">
        UPDATE inbox_events
        SET status='PROCESSING'
        WHERE event_id = #{eventId}
          AND status='RECEIVED'
    </update>

    <update id="updateDone">
        UPDATE inbox_events
        SET status='DONE',
            processed_at=CURRENT_TIMESTAMP,
            error_message=NULL
        WHERE event_id = #{eventId}
    </update>

    <update id="updateFailed">
        UPDATE inbox_events
        SET status='FAILED',
            processed_at=CURRENT_TIMESTAMP,
            error_message=#{errorMessage}
        WHERE event_id = #{eventId}
    </update>

    <select id="selectReceived"
            resultType="aladin.webhook.infra.mybatis.model.InboxEventRow">
        SELECT
            inbox_event_id,
            event_id,
            source_system,
            event_type,
            account_key,
            signature,
            request_timestamp,
            payload_json,
            status,
            error_message,
            received_at,
            processed_at
        FROM inbox_events
        WHERE status='RECEIVED'
        ORDER BY received_at ASC
            LIMIT #{limit}
    </select>

</mapper>
